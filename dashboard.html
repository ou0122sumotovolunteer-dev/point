<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—èˆ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<style>
body{
  font-family:sans-serif;
  background:#f4f1ea;
  margin:0;
}
.header{
  background:#c05a2b;
  color:white;
  padding:20px;
  text-align:center;
}
.section{
  padding:20px;
}
.card{
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  max-width:600px;
  margin:20px auto;
}
h2{
  margin-top:0;
}
.stat{
  font-size:20px;
  margin:8px 0;
}
.historyItem{
  font-size:13px;
  margin:6px 0;
  border-bottom:1px solid #eee;
  padding-bottom:4px;
}
input{
  padding:10px;
  border-radius:8px;
  width:80%;
}
button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#c05a2b;
  color:white;
  cursor:pointer;
  margin-top:8px;
}
.result{
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


/* Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* åº—èˆ—ä¸€è¦§ */
const shops = {
  shop01: "ã»ãŸã‚‹ã®å®¿",
  shop02: "ãŸã“ãŸã“",
  shop03: "starbase",
  shop04: "ã‚±ã‚¤ã‚º ãƒˆãƒ©ãƒ™ãƒ« ãƒ—ãƒ©ãƒ³",
  shop05: "ã‚µãƒ³ç¾å®¹å®¤",
  shop06: "HELLO PANDA",
  shop07: "ETHICA",
  shop08: "ajuga",
  shop09: "ãƒ•ã‚¯ã‚¹ã‚±äº­",
  shop10: "ã‚ã ã‹å±‹ç¦åŠ©äº­",
  shop11: "ï¼°ï¼µï¼²ï¼¡ï¼²ï¼¥ï¼š",
  shop12: "ã‚ªãƒªã‚ªãƒ³",
  shop13: "ãªã¹ç§€é™¶å™¨åº— å¹¸ç”ºåº—",
  shop14: "ã´ã‹ã„ã¡ã“ã¿ã¡",
  shop15: "ã“ã¿ã¡é£Ÿå ‚",
  shop16: "ã‚½ãƒ©ãƒã‚¢ã‚«ãƒª ã‚«ãƒ©ã‚³ãƒ«ãƒ ",
  shop17: "hugne.",
  shop18: "freestars",
  shop19: "æ´²æœ¬å®¶",
  shop20: "é™¶koubou m",
  shop21: "ãƒãƒ£ãƒ«ãƒ©ãƒ¼ãƒ«",
  shop22: "ç¬¬å…«æˆä¸¸",
  shop23: "La Ruelle.",
  shop24: "ãƒãƒ¼ã‚¨ãƒˆãƒ¯ãƒ¼ãƒ«",
  shop25: "coffe and bake stand pegasus"
};


/* URLã‹ã‚‰åº—èˆ—å–å¾— */
const params = new URLSearchParams(location.search);
const shopId = params.get("shop");

if(!shopId || !shops[shopId]){
  document.getElementById("app").innerHTML =
  "<div class='card'><h2>åº—èˆ—æŒ‡å®šã‚¨ãƒ©ãƒ¼</h2></div>";
}else{
  loadDashboard();
}


/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ */
async function loadDashboard(){

  const q = query(
    collection(db,"logs"),
    where("shop","==",shopId)
  );

  const snap = await getDocs(q);

  let totalAdd = 0;
  let totalUse = 0;
  let historyHTML = "";

  snap.forEach(docu=>{
    const d = docu.data();

    if(d.type === "add"){
      totalAdd += d.points || 0;
    }

    if(d.type === "use"){
      totalUse += 1;
    }

    const time = d.time
      ? new Date(d.time.seconds * 1000).toLocaleString()
      : "";

    historyHTML += `
      <div class="historyItem">
      ${d.type === "add" ? "ï¼‹" + (d.points || 0) + "P" : "ï¼3P"}
      (${time})
      </div>
    `;
  });

  document.getElementById("app").innerHTML = `
  <div class="header">
    <h1>${shops[shopId]} ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  </div>

  <div class="section">

    <div class="card">
      <h2>ğŸ“Š çµ±è¨ˆ</h2>
      <div class="stat">ç·ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆï¼š${totalAdd} P</div>
      <div class="stat">ç·åˆ©ç”¨å›æ•°ï¼š${totalUse} å›</div>
    </div>

    <div class="card">
      <h2>ğŸ§¾ åˆ©ç”¨ã‚³ãƒ¼ãƒ‰ç…§åˆ</h2>
      <input type="text" id="checkCodeInput" placeholder="ã‚³ãƒ¼ãƒ‰å…¥åŠ›">
      <br>
      <button onclick="checkUseCode()">ç…§åˆã™ã‚‹</button>
      <div id="checkResult" class="result"></div>
    </div>

    <div class="card">
      <h2>ğŸ“œ å±¥æ­´</h2>
      ${historyHTML || "å±¥æ­´ãªã—"}
    </div>

  </div>
  `;
}


/* ã‚³ãƒ¼ãƒ‰ç…§åˆ */
window.checkUseCode = async function(){

  const code =
  document.getElementById("checkCodeInput")
  .value
  .trim()
  .toUpperCase();

  if(!code){
    alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const q = query(
    collection(db,"logs"),
    where("shop","==",shopId),
    where("type","==","use"),
    where("useCode","==",code)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    document.getElementById("checkResult").innerHTML =
    "<span style='color:red;'>âŒ ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰</span>";
    return;
  }

  let docRef;
  let alreadyUsed = false;

  snap.forEach(docu=>{
    docRef = docu.ref;
    const d = docu.data();
    if(d.usedConfirmed){
      alreadyUsed = true;
    }
  });

  if(alreadyUsed){
    document.getElementById("checkResult").innerHTML =
    "<span style='color:orange;'>âš  ã™ã§ã«ä½¿ç”¨æ¸ˆã¿</span>";
  }else{
    window._currentCodeRef = docRef;
    document.getElementById("checkResult").innerHTML =
    "<span style='color:green;'>âœ… æœ‰åŠ¹ãªã‚³ãƒ¼ãƒ‰</span><br><button onclick='confirmUseCode()'>ä½¿ç”¨ç¢ºå®š</button>";
  }
};


/* ä½¿ç”¨ç¢ºå®š */
window.confirmUseCode = async function(){

  if(!window._currentCodeRef) return;

  await updateDoc(window._currentCodeRef,{
    usedConfirmed: true
  });

  document.getElementById("checkResult").innerHTML =
  "<span style='color:blue;'>âœ” ä½¿ç”¨ç¢ºå®šã—ã¾ã—ãŸ</span>";
};

</script>

</body>
</html>
