<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>レトロこみち ポイントイベント</title>

<style>
body{
  margin:0;
  font-family: "Hiragino Kaku Gothic ProN", sans-serif;
  background: linear-gradient(135deg,#fdf6e3,#f3e9d2);
  color:#333;
}

/* ヘッダー */
.hero{
  background: linear-gradient(90deg,#7b2d26,#c44536);
  color:white;
  padding:25px;
  text-align:center;
  position:relative;
  font-size:22px;
  letter-spacing:2px;
}

/* 管理ボタン */
.adminBtn{
  position:absolute;
  top:15px;
  right:15px;
  background:rgba(255,255,255,0.2);
  backdrop-filter:blur(5px);
  border-radius:20px;
  padding:6px 12px;
  font-size:14px;
  border:1px solid rgba(255,255,255,0.3);
}

/* セクション */
.section{
  padding:25px 15px;
}

/* カード */
.card{
  background:white;
  border-radius:20px;
  padding:25px;
  margin:20px auto;
  max-width:520px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  transition:0.3s;
}
.card:hover{
  transform:translateY(-3px);
}

/* ポイントバッジ */
.pointCircle{
  width:140px;
  height:140px;
  border-radius:50%;
  background: radial-gradient(circle,#ffd166,#f4a261);
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 15px;
  font-size:28px;
  font-weight:bold;
  color:#7b2d26;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}

/* ボタン */
button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:linear-gradient(90deg,#c44536,#e17055);
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  transition:0.2s;
}
button:hover{
  transform:scale(1.05);
}

/* 入力 */
select,input{
  padding:12px;
  width:80%;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:10px;
}

/* 履歴 */
.historyItem{
  text-align:left;
  padding:8px 0;
  border-bottom:1px dashed #ccc;
  font-size:14px;
}

/* モーダル */
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
}
.modalContent{
  background:rgba(255,255,255,0.95);
  backdrop-filter:blur(10px);
  padding:25px;
  border-radius:20px;
  width:320px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

/* 利用番号 */
.code{
  font-size:40px;
  letter-spacing:8px;
  margin:20px 0;
  color:#c44536;
}
</style>
</head>
<body>

<div id="app"></div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase設定 */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* 店舗 */
const shops = {
  shop01:"たこたこ",
  shop02:"こみち食堂",
  shop03:"レトロカフェ"
};

/* 管理コード */
const STAFF_CODE="RETRO2024";

/* ユーザーID */
let userId = localStorage.getItem("retroUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("retroUserId", userId);
}

/* URL判定 */
const params = new URLSearchParams(location.search);
const mode = params.get("mode");
const shopId = params.get("shop");

/* 初期化 */
async function init(){
  const ref = doc(db,"users",userId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{points:0,surveyCompleted:false});
    renderSurvey();
  }else{
    const data=snap.data();
    if(!data.surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* アンケート */
function renderSurvey(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>アンケートにご回答ください</h2>

<p>在住エリア</p>
<select id="area">
<option value="">選択</option>
<option>洲本市</option>
<option>洲本市外</option>
<option>淡路島内</option>
<option>淡路島外</option>
</select>

<p>年代</p>
<select id="age">
<option value="">選択</option>
<option>10代</option>
<option>20代</option>
<option>30代</option>
<option>40代</option>
<option>50代以上</option>
</select>

<br>
<button onclick="submitSurvey()">回答して参加する</button>
</div>`;
}

window.submitSurvey=async function(){
const area=document.getElementById("area").value;
const age=document.getElementById("age").value;
if(!area||!age){alert("選択してください");return;}

await updateDoc(doc(db,"users",userId),{
surveyCompleted:true,
survey:{area,age,answeredAt:Date.now()}
});
route();
};

/* ルーティング */
function route(){
if(mode==="add"&&shopId){renderAdd();}
else if(mode==="use"&&shopId){renderUse();}
else{renderHome();}
}

/* ホーム */
async function renderHome(){
const snap=await getDoc(doc(db,"users",userId));
const points=snap.data().points;

let historyHTML="";
const q=query(collection(db,"logs"),where("userId","==",userId));
const logs=await getDocs(q);
logs.forEach(docu=>{
const d=docu.data();
const time=new Date(d.time).toLocaleString();
if(d.type==="add"){
historyHTML+=`<div class="historyItem">＋${d.points}P (${shops[d.shop]}) ${time}</div>`;
}
if(d.type==="use"){
historyHTML+=`<div class="historyItem">－3P 利用(${shops[d.shop]}) ${time}</div>`;
}
});

document.getElementById("app").innerHTML=`
<div class="hero">
<h1>レトロこみち ポイントイベント</h1>
<button class="adminBtn" onclick="showAdminLogin()">⚙</button>
</div>

<div class="section">
<div class="card">
<h2>現在 ${points} ポイント</h2>
</div>
</div>

<div class="section">
<div class="card">
<h3>開催概要</h3>
<p>300円ごとに1ポイント</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>景品紹介</h3>
<p>3ポイントで各店舗特典</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>履歴</h3>
${historyHTML||"履歴なし"}
</div>
</div>
`;
}

/* QR付与 */
function renderAdd(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<input type="number" id="amount" placeholder="金額">
<br>
<button onclick="addPoints()">付与</button>
</div>`;
}

window.addPoints=async function(){
const amount=parseInt(document.getElementById("amount").value);
if(!amount||amount<300){alert("300円以上");return;}
const add=Math.floor(amount/300);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+add});
await addDoc(collection(db,"logs"),{
userId,type:"add",shop:shopId,points:add,time:Date.now()
});
location.href=location.origin;
};

/* QR利用 */
async function renderUse(){
const snap=await getDoc(doc(db,"users",userId));
if(snap.data().points<3){
document.getElementById("app").innerHTML=`<div class="card"><h2>ポイント不足</h2></div>`;
return;
}
document.getElementById("app").innerHTML=`
<div class="card">
<button onclick="usePoints()">3ポイント利用</button>
</div>`;
}

window.usePoints=async function(){
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-3});
await addDoc(collection(db,"logs"),{
userId,type:"use",shop:shopId,time:Date.now()
});
location.href=location.origin;
};

/* 管理ログイン */
window.showAdminLogin=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="loginModal">
<div class="modalContent">
<h3>関係者コード</h3>
<input type="password" id="codeInput"><br>
<button onclick="checkCode()">ログイン</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>`);
};

window.checkCode=function(){
const c=document.getElementById("codeInput").value;
if(c===STAFF_CODE){
closeModal();
showAdminPanel();
}else{alert("違います");}
};

window.closeModal=function(){
document.getElementById("loginModal").remove();
};

/* 管理パネル */
window.showAdminPanel=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="adminPanel">
<div class="modalContent">
<h3>管理メニュー</h3>
<input type="number" id="manualPoint" placeholder="ポイント数"><br>
<button onclick="manualAdd()">手動付与</button>
<button onclick="manualRemove()">手動削除</button>
<button onclick="resetPoints()">ポイントリセット</button>
<button onclick="fullReset()">完全初期化</button>
<button onclick="closePanel()">閉じる</button>
</div>
</div>`);
};

window.closePanel=function(){
document.getElementById("adminPanel").remove();
};

window.manualAdd=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+val});
alert("付与完了");
};

window.manualRemove=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-val});
alert("削除完了");
};

window.resetPoints=async function(){
await updateDoc(doc(db,"users",userId),{points:0});
alert("リセット完了");
};

window.fullReset=async function(){
await updateDoc(doc(db,"users",userId),{
points:0,
surveyCompleted:false
});
alert("完全初期化完了");
location.reload();
};

init();
</script>
</body>
</html>
