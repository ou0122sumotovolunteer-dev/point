<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ</title>

<style>
body{
  font-family:sans-serif;
  background:#f4f1ea;
  margin:0;
}
.hero{
  background:#c05a2b;
  color:white;
  padding:30px;
  text-align:center;
  position:relative;
}
.section{ padding:25px; }
.card{
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  max-width:500px;
  margin:20px auto;
  text-align:center;
}
button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:#c05a2b;
  color:white;
  cursor:pointer;
  margin:6px;
}
select,input{
  padding:10px;
  border-radius:8px;
  width:80%;
  margin-top:10px;
}
.code{
  font-size:36px;
  letter-spacing:6px;
  margin:15px 0;
}
.adminBtn{
  position:absolute;
  top:10px;
  right:15px;
  background:#333;
  font-size:12px;
}
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modalContent{
  background:white;
  padding:20px;
  border-radius:12px;
  width:320px;
  text-align:center;
}
.historyItem{
  font-size:13px;
  margin:6px 0;
  border-bottom:1px solid #eee;
  padding-bottom:4px;
}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where,
  Timestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


/* Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* åº—èˆ— */
const shops = {
  shop01: "ã»ãŸã‚‹ã®å®¿",
  shop02: "ãŸã“ãŸã“",
  shop03: "starbase",
  shop04: "ã‚±ã‚¤ã‚º ãƒˆãƒ©ãƒ™ãƒ« ãƒ—ãƒ©ãƒ³",
  shop05: "ã‚µãƒ³ç¾å®¹å®¤",
  shop06: "HELLO PANDA",
  shop07: "ETHICA",
  shop08: "ajuga",
  shop09: "ãƒ•ã‚¯ã‚¹ã‚±äº­",
  shop10: "ã‚ã ã‹å±‹ç¦åŠ©äº­",
  shop11: "ï¼°ï¼µï¼²ï¼¡ï¼²ï¼¥ï¼š",
  shop12: "ã‚ªãƒªã‚ªãƒ³",
  shop13: "ãªã¹ç§€é™¶å™¨åº— å¹¸ç”ºåº—",
  shop14: "ã´ã‹ã„ã¡ã“ã¿ã¡",
  shop15: "ã“ã¿ã¡é£Ÿå ‚",
  shop16: "ã‚½ãƒ©ãƒã‚¢ã‚«ãƒª ã‚«ãƒ©ã‚³ãƒ«ãƒ ",
  shop17: "hugne.",
  shop18: "freestars",
  shop19: "æ´²æœ¬å®¶",
  shop20: "é™¶koubou m",
  shop21: "ãƒãƒ£ãƒ«ãƒ©ãƒ¼ãƒ«",
  shop22: "ç¬¬å…«æˆä¸¸",
  shop23: "La Ruelle.",
  shop24: "ãƒãƒ¼ã‚¨ãƒˆãƒ¯ãƒ¼ãƒ«",
  shop25: "coffe and bake stand pegasus"
};

/* ç®¡ç†ã‚³ãƒ¼ãƒ‰ */
const STAFF_CODE="RETRO2024";

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
let userId = localStorage.getItem("retroUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("retroUserId", userId);
}

/* URLåˆ¤å®š */
const params = new URLSearchParams(location.search);
const mode = params.get("mode");
const shopId = params.get("shop");

/* åˆæœŸåŒ– */
async function init(){
  const ref = doc(db,"users",userId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{points:0,surveyCompleted:false});
    renderSurvey();
  }else{
    const data=snap.data();
    if(!data.surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ */
function renderSurvey(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å›ç­”ãã ã•ã„</h2>

<p>åœ¨ä½ã‚¨ãƒªã‚¢</p>
<select id="area">
<option value="">é¸æŠ</option>
<option>æ´²æœ¬å¸‚</option>
<option>æ´²æœ¬å¸‚å¤–</option>
<option>æ·¡è·¯å³¶å†…</option>
<option>æ·¡è·¯å³¶å¤–</option>
</select>

<p>å¹´ä»£</p>
<select id="age">
<option value="">é¸æŠ</option>
<option>10ä»£</option>
<option>20ä»£</option>
<option>30ä»£</option>
<option>40ä»£</option>
<option>50ä»£ä»¥ä¸Š</option>
</select>

<br>
<button onclick="submitSurvey()">å›ç­”ã—ã¦å‚åŠ ã™ã‚‹</button>
</div>`;
}

window.submitSurvey=async function(){
const area=document.getElementById("area").value;
const age=document.getElementById("age").value;
if(!area||!age){alert("é¸æŠã—ã¦ãã ã•ã„");return;}

await updateDoc(doc(db,"users",userId),{
surveyCompleted:true,
survey:{area,age,answeredAt:Date.now()}
});
route();
};

/* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° */
function route(){
if(mode==="add"&&shopId){renderAdd();}
else if(mode==="use"&&shopId){renderUse();}
else{renderHome();}
}

/* ãƒ›ãƒ¼ãƒ  */
async function renderHome(){
const snap=await getDoc(doc(db,"users",userId));
const points=snap.data().points;

let historyHTML="";
const q=query(collection(db,"logs"),where("userId","==",userId));
const logs=await getDocs(q);
logs.forEach(docu=>{
const d=docu.data();
const time = d.time
  ? new Date(d.time.seconds * 1000).toLocaleString()
  : "";
if(d.type==="add"){
historyHTML+=`<div class="historyItem">ï¼‹${d.points}P (${shops[d.shop]}) ${time}</div>`;
}
if(d.type==="use"){
historyHTML+=`<div class="historyItem">ï¼3P åˆ©ç”¨(${shops[d.shop]}) ${time}</div>`;
}
});

document.getElementById("app").innerHTML=`
<div class="hero">
<h1>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ</h1>
<button class="adminBtn" onclick="showAdminLogin()">âš™</button>
</div>

<div class="section">
<div class="card">
<h2>ç¾åœ¨ ${points} ãƒã‚¤ãƒ³ãƒˆ</h2>
</div>
</div>

<div class="section">
<div class="card">
<h3>é–‹å‚¬æ¦‚è¦</h3>
<p>300å††ã”ã¨ã«1ãƒã‚¤ãƒ³ãƒˆ</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>æ™¯å“ç´¹ä»‹</h3>
<p>3ãƒã‚¤ãƒ³ãƒˆã§å„åº—èˆ—ç‰¹å…¸</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>å±¥æ­´</h3>
${historyHTML||"å±¥æ­´ãªã—"}
</div>
</div>
`;
}

/* QRä»˜ä¸ */
function renderAdd(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<input type="number" id="amount" placeholder="é‡‘é¡">
<br>
<button onclick="addPoints()">ä»˜ä¸</button>
</div>`;
}

window.addPoints = async function(){

const amount =
parseInt(document.getElementById("amount").value);

if(!amount || amount < 300){
 alert("300å††ä»¥ä¸Š");
 return;
}

const add =
Math.floor(amount / 300);

const ref =
doc(db,"users",userId);

const snap =
await getDoc(ref);

const current =
Number(snap.data()?.points) || 0;

const twelveHours =
12 * 60 * 60 * 1000;

const now =
Date.now();

const q =
query(
 collection(db,"logs"),
 where("userId","==",userId),
 where("shop","==",shopId),
 where("type","==","add")
);

const logSnap =
await getDocs(q);

let blocked = false;

logSnap.forEach(doc=>{
const time =
doc.data().time?.toMillis() || 0;
 if(now - time < twelveHours){
  blocked = true;
 }
});

if(blocked){
 alert("ã“ã®åº—èˆ—ã§ã¯12æ™‚é–“ä»¥å†…ã«ä»˜ä¸æ¸ˆã¿ã§ã™");
 return;
}

/* ä»˜ä¸ */

// ğŸ”´ å…ˆã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
if(user.status === "hold"){
  alert("ç¾åœ¨ä¿ç•™ä¸­ã®ãŸã‚ä»˜ä¸ã§ãã¾ã›ã‚“");
  return;
}

if(user.status === "banned"){
  alert("åˆ©ç”¨åœæ­¢ä¸­ã§ã™");
  return;
}

// ğŸŸ¢ OKãªã‚‰æ›´æ–°
await updateDoc(ref,{
  points: current + add
});

// ğŸŸ¢ ãƒ­ã‚°ä¿å­˜
await addDoc(collection(db,"logs"),{
  userId: userId,
  type: "add",
  shop: shopId,
  points: add,
  time: Timestamp.now()
});

/* å®Œäº†ç”»é¢ */
const timeStr =
new Date(now).toLocaleString();

document.getElementById("app").innerHTML=`
<div class="card">
<h2>ãƒã‚¤ãƒ³ãƒˆä»˜ä¸å®Œäº†</h2>
<p><strong>${shops[shopId]}</strong></p>
<p>${timeStr}</p>
<p><span style="font-size:28px;color:#c05a2b;">ï¼‹${add} ãƒã‚¤ãƒ³ãƒˆ</span></p>
<br>
<button onclick="location.href='https://ou0122sumotovolunteer-dev.github.io/point/'">
ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
</button>
</div>
`;

};

/* QRåˆ©ç”¨ */
async function renderUse(){
const snap=await getDoc(doc(db,"users",userId));
if(snap.data().points<3){
document.getElementById("app").innerHTML=`<div class="card"><h2>ãƒã‚¤ãƒ³ãƒˆä¸è¶³</h2></div>`;
return;
}
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<p>3ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ã—ã¾ã™</p>
<button onclick="confirmUse()">åˆ©ç”¨ã™ã‚‹</button>
</div>`;
}


window.confirmUse=function(){
if(!confirm("æœ¬å½“ã«åˆ©ç”¨ã—ã¾ã™ã‹ï¼Ÿ")){
 return;
}
if(!confirm("å†ç¢ºèªï¼š3ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
 return;
}
usePoints();
};

async function usePoints(){

const ref=doc(db,"users",userId);
const snap=await getDoc(ref);

await updateDoc(ref,{
 points:snap.data().points-3
});

const now=Date.now();
const code=
Math.random().toString(36)
.substring(2,8)
.toUpperCase();

await addDoc(collection(db,"logs"),{
 userId:userId,
 type:"use",
 shop:shopId,
 time: Timestamp.now(),
useCode: code
});

const timeStr =
new Date(now).toLocaleString();

document.getElementById("app").innerHTML=`
<div class="card">
<h2>åˆ©ç”¨å®Œäº†</h2>
<p><strong>${shops[shopId]}</strong></p>
<p>${timeStr}</p>
<p>ï¼3ãƒã‚¤ãƒ³ãƒˆ</p>
<div class="code">${code}</div>
<p style="font-size:12px;">â€»åº—èˆ—ã¸ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æç¤ºã—ã¦ãã ã•ã„</p>
<br>
<button onclick="location.href='https://ou0122sumotovolunteer-dev.github.io/point/'">
ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
</button>
</div>
`;

}

/* ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³ */
window.showAdminLogin=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="loginModal">
<div class="modalContent">
<h3>é–¢ä¿‚è€…ã‚³ãƒ¼ãƒ‰</h3>
<input type="password" id="codeInput"><br>
<button onclick="checkCode()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button onclick="closeModal()">é–‰ã˜ã‚‹</button>
</div>
</div>`);
};

window.checkCode=function(){
const c=document.getElementById("codeInput").value;
if(c===STAFF_CODE){
closeModal();
showAdminPanel();
}else{alert("é•ã„ã¾ã™");}
};

window.closeModal=function(){
document.getElementById("loginModal").remove();
};

/* ç®¡ç†ãƒ‘ãƒãƒ« */
window.showAdminPanel=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="adminPanel">
<div class="modalContent">
<h3>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
<input type="number" id="manualPoint" placeholder="ãƒã‚¤ãƒ³ãƒˆæ•°"><br>
<button onclick="manualAdd()">æ‰‹å‹•ä»˜ä¸</button>
<button onclick="manualRemove()">æ‰‹å‹•å‰Šé™¤</button>
<button onclick="resetPoints()">ãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
<button onclick="fullReset()">å®Œå…¨åˆæœŸåŒ–</button>
<button onclick="closePanel()">é–‰ã˜ã‚‹</button>
</div>
</div>`);
};

window.closePanel=function(){
document.getElementById("adminPanel").remove();
};

window.manualAdd=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+val});
alert("ä»˜ä¸å®Œäº†");
};

window.manualRemove=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-val});
alert("å‰Šé™¤å®Œäº†");
};

window.resetPoints=async function(){
await updateDoc(doc(db,"users",userId),{points:0});
alert("ãƒªã‚»ãƒƒãƒˆå®Œäº†");
};

window.fullReset=async function(){
await updateDoc(doc(db,"users",userId),{
points:0,
surveyCompleted:false
});
alert("å®Œå…¨åˆæœŸåŒ–å®Œäº†");
location.reload();
};

init();
</script>
</body>
</html>
