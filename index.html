<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>レトロこみち ポイントサービス</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f4f6f8;
  color:#222;
}

/* 上部バー */
.topBar{
  background:white;
  padding:18px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}

.balanceBox{
  font-size:28px;
  font-weight:bold;
}

.balanceBox small{
  font-size:13px;
  color:#888;
  display:block;
}

.adminBtn{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  color:#888;
}

/* カード */
.card{
  background:white;
  margin:16px;
  padding:18px;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}

.sectionTitle{
  font-size:14px;
  color:#666;
  margin-bottom:10px;
}

/* ボタン */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#2d7ef7;
  color:white;
  font-size:15px;
  margin-top:10px;
  cursor:pointer;
}

button.secondary{
  background:#eee;
  color:#333;
}

input,select{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ddd;
  margin-top:10px;
}

/* 履歴 */
.historyItem{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid #eee;
  font-size:14px;
}

.plus{ color:#2e7d32; }
.minus{ color:#c62828; }

/* モーダル */
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modalContent{
  background:white;
  padding:20px;
  border-radius:14px;
  width:320px;
  text-align:center;
}

.code{
  font-size:36px;
  letter-spacing:6px;
  margin:20px 0;
}
</style>
</head>

<body>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase設定 */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* 店舗 */
const shops={
  shop01:"たこたこ",
  shop02:"こみち食堂",
  shop03:"レトロカフェ"
};

/* 管理コード */
const STAFF_CODE="RETRO2024";

/* ユーザーID */
let userId=localStorage.getItem("retroUserId");
if(!userId){
  userId=crypto.randomUUID();
  localStorage.setItem("retroUserId",userId);
}

const params=new URLSearchParams(location.search);
const mode=params.get("mode");
const shopId=params.get("shop");

/* 初期化 */
async function init(){
  const ref=doc(db,"users",userId);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{points:0,surveyCompleted:false});
    renderSurvey();
  }else{
    if(!snap.data().surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* アンケート */
function renderSurvey(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>アンケート</h2>

<select id="area">
<option value="">在住エリア</option>
<option>洲本市</option>
<option>洲本市外</option>
<option>淡路島内</option>
<option>淡路島外</option>
</select>

<select id="age">
<option value="">年代</option>
<option>10代</option>
<option>20代</option>
<option>30代</option>
<option>40代</option>
<option>50代以上</option>
</select>

<button onclick="submitSurvey()">回答して参加する</button>
</div>`;
}

window.submitSurvey=async function(){
const area=document.getElementById("area").value;
const age=document.getElementById("age").value;
if(!area||!age){alert("選択してください");return;}
await updateDoc(doc(db,"users",userId),{
surveyCompleted:true,
survey:{area,age,answeredAt:Date.now()}
});
route();
};

/* ルート */
function route(){
if(mode==="add"&&shopId){renderAdd();}
else if(mode==="use"&&shopId){renderUse();}
else{renderHome();}
}

/* ホーム */
async function renderHome(){
const snap=await getDoc(doc(db,"users",userId));
const points=snap.data().points;

let historyHTML="";
const q=query(collection(db,"logs"),where("userId","==",userId));
const logs=await getDocs(q);
logs.forEach(d=>{
const data=d.data();
const time=new Date(data.time).toLocaleString();
if(data.type==="add"){
historyHTML+=`<div class="historyItem plus"><span>＋${data.points}P (${shops[data.shop]})</span><span>${time}</span></div>`;
}
if(data.type==="use"){
historyHTML+=`<div class="historyItem minus"><span>−3P (${shops[data.shop]})</span><span>${time}</span></div>`;
}
});

document.getElementById("app").innerHTML=`
<div class="topBar">
<div class="balanceBox">
${points}P
<small>現在のポイント</small>
</div>
<button class="adminBtn" onclick="showAdminLogin()">⚙</button>
</div>

<div class="card">
<div class="sectionTitle">履歴</div>
${historyHTML||"履歴はありません"}
</div>
`;
}

/* QR付与 */
function renderAdd(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<input type="number" id="amount" placeholder="金額（円）">
<button onclick="addPoints()">ポイント付与</button>
</div>`;
}

window.addPoints=async function(){
const amount=parseInt(document.getElementById("amount").value);
if(!amount||amount<300){alert("300円以上");return;}
const add=Math.floor(amount/300);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+add});
await addDoc(collection(db,"logs"),{
userId,type:"add",shop:shopId,points:add,time:Date.now()
});
location.href=location.origin;
};

/* QR利用 */
async function renderUse(){
const snap=await getDoc(doc(db,"users",userId));
if(snap.data().points<3){
document.getElementById("app").innerHTML=`<div class="card"><h2>ポイント不足</h2></div>`;
return;
}
document.getElementById("app").innerHTML=`
<div class="card">
<button onclick="usePoints()">3ポイント利用</button>
</div>`;
}

window.usePoints=async function(){
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
const newTotal=snap.data().points-3;
await updateDoc(ref,{points:newTotal});

const code=Math.floor(100+Math.random()*900)+
String.fromCharCode(65+Math.floor(Math.random()*26));

await addDoc(collection(db,"logs"),{
userId,type:"use",shop:shopId,code,time:Date.now()
});

document.getElementById("app").innerHTML=`
<div class="card">
<h2>利用番号</h2>
<div class="code">${code}</div>
<button onclick="location.href=location.origin">ホームへ戻る</button>
</div>`;
};

/* 管理ログイン */
window.showAdminLogin=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="loginModal">
<div class="modalContent">
<h3>関係者コード</h3>
<input type="password" id="codeInput">
<button onclick="checkCode()">ログイン</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>`);
};

window.checkCode=function(){
const c=document.getElementById("codeInput").value;
if(c===STAFF_CODE){
closeModal();
showAdminPanel();
}else{alert("コードが違います");}
};

window.closeModal=function(){
document.getElementById("loginModal").remove();
};

window.showAdminPanel=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="adminPanel">
<div class="modalContent">
<h3>管理メニュー</h3>
<input type="number" id="manualPoint" placeholder="ポイント数">
<button onclick="manualAdd()">手動付与</button>
<button onclick="manualRemove()">手動削除</button>
<button onclick="resetPoints()">ポイントリセット</button>
<button onclick="fullReset()">完全初期化</button>
<button onclick="closePanel()">閉じる</button>
</div>
</div>`);
};

window.closePanel=function(){
document.getElementById("adminPanel").remove();
};

window.manualAdd=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+val});
alert("付与完了");
};

window.manualRemove=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-val});
alert("削除完了");
};

window.resetPoints=async function(){
await updateDoc(doc(db,"users",userId),{points:0});
alert("リセット完了");
};

window.fullReset=async function(){
await updateDoc(doc(db,"users",userId),{
points:0,
surveyCompleted:false
});
alert("完全初期化完了");
location.reload();
};

init();
</script>
</body>
</html>
