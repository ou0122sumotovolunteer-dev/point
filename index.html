<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>レトロこみち ポイントイベント</title>

<style>
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f5f6f8;
  color:#222;
}

/* 上部残高バー */
.topBar{
  background:white;
  padding:20px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.balance{
  font-size:28px;
  font-weight:bold;
}

.balance small{
  font-size:14px;
  color:#888;
}

/* セクションカード */
.sectionCard{
  background:white;
  margin:16px;
  padding:18px;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,0.04);
}

.sectionTitle{
  font-size:14px;
  color:#666;
  margin-bottom:10px;
}

/* ボタン */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#2d7ef7;
  color:white;
  font-size:15px;
  margin-top:8px;
  cursor:pointer;
}

button.secondary{
  background:#eee;
  color:#333;
}

/* 履歴 */
.historyItem{
  display:flex;
  justify-content:space-between;
  padding:10px 0;
  border-bottom:1px solid #eee;
  font-size:14px;
}

.plus{ color:#2e7d32; }
.minus{ color:#c62828; }

/* 管理ボタン */
.adminBtn{
  font-size:14px;
  background:none;
  color:#888;
  border:none;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="app"></div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase設定 */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* 店舗 */
const shops = {
  shop01:"たこたこ",
  shop02:"こみち食堂",
  shop03:"レトロカフェ"
};

/* 管理コード */
const STAFF_CODE="RETRO2024";

/* ユーザーID */
let userId = localStorage.getItem("retroUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("retroUserId", userId);
}

/* URL判定 */
const params = new URLSearchParams(location.search);
const mode = params.get("mode");
const shopId = params.get("shop");

/* 初期化 */
async function init(){
  const ref = doc(db,"users",userId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{points:0,surveyCompleted:false});
    renderSurvey();
  }else{
    const data=snap.data();
    if(!data.surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* アンケート */
function renderSurvey(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>アンケートにご回答ください</h2>

<p>在住エリア</p>
<select id="area">
<option value="">選択</option>
<option>洲本市</option>
<option>洲本市外</option>
<option>淡路島内</option>
<option>淡路島外</option>
</select>

<p>年代</p>
<select id="age">
<option value="">選択</option>
<option>10代</option>
<option>20代</option>
<option>30代</option>
<option>40代</option>
<option>50代以上</option>
</select>

<br>
<button onclick="submitSurvey()">回答して参加する</button>
</div>`;
}

window.submitSurvey=async function(){
const area=document.getElementById("area").value;
const age=document.getElementById("age").value;
if(!area||!age){alert("選択してください");return;}

await updateDoc(doc(db,"users",userId),{
surveyCompleted:true,
survey:{area,age,answeredAt:Date.now()}
});
route();
};

/* ルーティング */
function route(){
if(mode==="add"&&shopId){renderAdd();}
else if(mode==="use"&&shopId){renderUse();}
else{renderHome();}
}

/* ホーム */
async function renderHome(){
const snap=await getDoc(doc(db,"users",userId));
const points=snap.data().points;

let historyHTML="";
const q=query(collection(db,"logs"),where("userId","==",userId));
const logs=await getDocs(q);
logs.forEach(docu=>{
const d=docu.data();
const time=new Date(d.time).toLocaleString();
if(d.type==="add"){
historyHTML+=`<div class="historyItem">＋${d.points}P (${shops[d.shop]}) ${time}</div>`;
}
if(d.type==="use"){
historyHTML+=`<div class="historyItem">－3P 利用(${shops[d.shop]}) ${time}</div>`;
}
});

document.getElementById("app").innerHTML=`
<div class="topBar">
  <div class="balance">
    ${points}P<br>
    <small>現在のポイント</small>
  </div>
  <button class="adminBtn" onclick="showAdminLogin()">⚙</button>
</div>

<div class="sectionCard">
  <div class="sectionTitle">ポイントを貯める</div>
  <p>店舗QRを読み取ってポイント獲得</p>
</div>

<div class="sectionCard">
  <div class="sectionTitle">ポイントを使う</div>
  <p>3ポイントで特典利用できます</p>
</div>

<div class="sectionCard">
  <div class="sectionTitle">履歴</div>
  ${historyHTML || "履歴はありません"}
</div>
`;

/* QR付与 */
function renderAdd(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<input type="number" id="amount" placeholder="金額">
<br>
<button onclick="addPoints()">付与</button>
</div>`;
}

window.addPoints=async function(){
const amount=parseInt(document.getElementById("amount").value);
if(!amount||amount<300){alert("300円以上");return;}
const add=Math.floor(amount/300);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+add});
await addDoc(collection(db,"logs"),{
userId,type:"add",shop:shopId,points:add,time:Date.now()
});
location.href=location.origin;
};

/* QR利用 */
async function renderUse(){
const snap=await getDoc(doc(db,"users",userId));
if(snap.data().points<3){
document.getElementById("app").innerHTML=`<div class="card"><h2>ポイント不足</h2></div>`;
return;
}
document.getElementById("app").innerHTML=`
<div class="card">
<button onclick="usePoints()">3ポイント利用</button>
</div>`;
}

window.usePoints=async function(){
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-3});
await addDoc(collection(db,"logs"),{
userId,type:"use",shop:shopId,time:Date.now()
});
location.href=location.origin;
};

/* 管理ログイン */
window.showAdminLogin=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="loginModal">
<div class="modalContent">
<h3>関係者コード</h3>
<input type="password" id="codeInput"><br>
<button onclick="checkCode()">ログイン</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>`);
};

window.checkCode=function(){
const c=document.getElementById("codeInput").value;
if(c===STAFF_CODE){
closeModal();
showAdminPanel();
}else{alert("違います");}
};

window.closeModal=function(){
document.getElementById("loginModal").remove();
};

/* 管理パネル */
window.showAdminPanel=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="adminPanel">
<div class="modalContent">
<h3>管理メニュー</h3>
<input type="number" id="manualPoint" placeholder="ポイント数"><br>
<button onclick="manualAdd()">手動付与</button>
<button onclick="manualRemove()">手動削除</button>
<button onclick="resetPoints()">ポイントリセット</button>
<button onclick="fullReset()">完全初期化</button>
<button onclick="closePanel()">閉じる</button>
</div>
</div>`);
};

window.closePanel=function(){
document.getElementById("adminPanel").remove();
};

window.manualAdd=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+val});
alert("付与完了");
};

window.manualRemove=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-val});
alert("削除完了");
};

window.resetPoints=async function(){
await updateDoc(doc(db,"users",userId),{points:0});
alert("リセット完了");
};

window.fullReset=async function(){
await updateDoc(doc(db,"users",userId),{
points:0,
surveyCompleted:false
});
alert("完全初期化完了");
location.reload();
};

init();
</script>
</body>
</html>
