<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>レトロこみち ポイントイベント</title>

<style>
body{
  font-family:sans-serif;
  background:#f4f1ea;
  margin:0;
}
.hero{
  background:#c05a2b;
  color:white;
  padding:30px;
  text-align:center;
  position:relative;
}
.section{ padding:25px; }
.card{
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  max-width:500px;
  margin:20px auto;
  text-align:center;
}
button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:#c05a2b;
  color:white;
  cursor:pointer;
  margin:6px;
}
select,input{
  padding:10px;
  border-radius:8px;
  width:80%;
  margin-top:10px;
}
.code{
  font-size:36px;
  letter-spacing:6px;
  margin:15px 0;
}
.adminBtn{
  position:absolute;
  top:10px;
  right:15px;
  background:#333;
  font-size:12px;
}
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modalContent{
  background:white;
  padding:20px;
  border-radius:12px;
  width:320px;
  text-align:center;
}
.historyItem{
  font-size:13px;
  margin:6px 0;
  border-bottom:1px solid #eee;
  padding-bottom:4px;
}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


/* Firebase設定 */
const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* 店舗 */
const shops = {
  shop01: "ほたるの宿",
  shop02: "たこたこ",
  shop03: "starbase",
  shop04: "ケイズ トラベル プラン",
  shop05: "サン美容室",
  shop06: "HELLO PANDA",
  shop07: "ETHICA",
  shop08: "ajuga",
  shop09: "フクスケ亭",
  shop10: "めだか屋福助亭",
  shop11: "ＰＵＲＡＲＥ：",
  shop12: "オリオン",
  shop13: "なべ秀陶器店 幸町店",
  shop14: "ぴかいちこみち",
  shop15: "こみち食堂",
  shop16: "ソラノアカリ カラコルム",
  shop17: "hugne.",
  shop18: "freestars",
  shop19: "洲本家",
  shop20: "陶koubou m",
  shop21: "チャルラール",
  shop22: "第八戎丸",
  shop23: "La Ruelle.",
  shop24: "バーエトワール",
  shop25: "coffe and bake stand pegasus"
};

/* 管理コード */
const STAFF_CODE="RETRO2024";

/* ユーザーID */
let userId = localStorage.getItem("retroUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("retroUserId", userId);
}

/* URL判定 */
const params = new URLSearchParams(location.search);
const mode = params.get("mode");
const shopId = params.get("shop");

/* 初期化 */
async function init(){
  const ref = doc(db,"users",userId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{points:0,surveyCompleted:false});
    renderSurvey();
  }else{
    const data=snap.data();
    if(!data.surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* アンケート */
function renderSurvey(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>アンケートにご回答ください</h2>

<p>在住エリア</p>
<select id="area">
<option value="">選択</option>
<option>洲本市</option>
<option>洲本市外</option>
<option>淡路島内</option>
<option>淡路島外</option>
</select>

<p>年代</p>
<select id="age">
<option value="">選択</option>
<option>10代</option>
<option>20代</option>
<option>30代</option>
<option>40代</option>
<option>50代以上</option>
</select>

<br>
<button onclick="submitSurvey()">回答して参加する</button>
</div>`;
}

window.submitSurvey=async function(){
const area=document.getElementById("area").value;
const age=document.getElementById("age").value;
if(!area||!age){alert("選択してください");return;}

await updateDoc(doc(db,"users",userId),{
surveyCompleted:true,
survey:{area,age,answeredAt:Date.now()}
});
route();
};

/* ルーティング */
function route(){
if(mode==="add"&&shopId){renderAdd();}
else if(mode==="use"&&shopId){renderUse();}
else{renderHome();}
}

/* ホーム */
async function renderHome(){
const snap=await getDoc(doc(db,"users",userId));
const points=snap.data().points;

let historyHTML="";
const q=query(collection(db,"logs"),where("userId","==",userId));
const logs=await getDocs(q);
logs.forEach(docu=>{
const d=docu.data();
const time = d.time
  ? new Date(d.time.seconds * 1000).toLocaleString()
  : "";
if(d.type==="add"){
historyHTML+=`<div class="historyItem">＋${d.points}P (${shops[d.shop]}) ${time}</div>`;
}
if(d.type==="use"){
historyHTML+=`<div class="historyItem">－3P 利用(${shops[d.shop]}) ${time}</div>`;
}
});

document.getElementById("app").innerHTML=`
<div class="hero">
<h1>レトロこみち ポイントイベント</h1>
<button class="adminBtn" onclick="showAdminLogin()">⚙</button>
</div>

<div class="section">
<div class="card">
<h2>現在 ${points} ポイント</h2>
</div>
</div>

<div class="section">
<div class="card">
<h3>開催概要</h3>
<p>300円ごとに1ポイント</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>景品紹介</h3>
<p>3ポイントで各店舗特典</p>
</div>
</div>

<div class="section">
<div class="card">
<h3>履歴</h3>
${historyHTML||"履歴なし"}
</div>
</div>
`;
}

/* QR付与 */
function renderAdd(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<input type="number" id="amount" placeholder="金額">
<br>
<button onclick="addPoints()">付与</button>
</div>`;
}

window.addPoints = async function(){

const amount =
parseInt(document.getElementById("amount").value);

if(!amount || amount < 300){
 alert("300円以上");
 return;
}

const add =
Math.floor(amount / 300);

const ref =
doc(db,"users",userId);

const snap =
await getDoc(ref);

const current =
Number(snap.data()?.points) || 0;

const twelveHours =
12 * 60 * 60 * 1000;

const now =
Date.now();

const q =
query(
 collection(db,"logs"),
 where("userId","==",userId),
 where("shop","==",shopId),
 where("type","==","add")
);

const logSnap =
await getDocs(q);

let blocked = false;

logSnap.forEach(doc=>{
const time =
doc.data().time?.toMillis() || 0;
 if(now - time < twelveHours){
  blocked = true;
 }
});

if(blocked){
 alert("この店舗では12時間以内に付与済みです");
 return;
}

/* 付与 */
await updateDoc(ref,{
 points: current + add
});

await addDoc(collection(db,"logs"),{
 userId: userId,
 type: "add",
 shop: shopId,
 points: add,
 time: Timestamp.now()
});

/* 完了画面 */
const timeStr =
new Date(now).toLocaleString();

document.getElementById("app").innerHTML=`
<div class="card">
<h2>ポイント付与完了</h2>
<p><strong>${shops[shopId]}</strong></p>
<p>${timeStr}</p>
<p><span style="font-size:28px;color:#c05a2b;">＋${add} ポイント</span></p>
<br>
<button onclick="location.href=location.origin">ホームへ戻る</button>
</div>
`;

};

/* QR利用 */
async function renderUse(){
const snap=await getDoc(doc(db,"users",userId));
if(snap.data().points<3){
document.getElementById("app").innerHTML=`<div class="card"><h2>ポイント不足</h2></div>`;
return;
}
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${shops[shopId]}</h2>
<p>3ポイント利用します</p>
<button onclick="confirmUse()">利用する</button>
</div>`;
}


window.confirmUse=function(){
if(!confirm("本当に利用しますか？")){
 return;
}
if(!confirm("再確認：3ポイント消費します。よろしいですか？")){
 return;
}
usePoints();
};

async function usePoints(){

const ref=doc(db,"users",userId);
const snap=await getDoc(ref);

await updateDoc(ref,{
 points:snap.data().points-3
});

const now=Date.now();
const code=
Math.random().toString(36)
.substring(2,8)
.toUpperCase();

await addDoc(collection(db,"logs"),{
 userId:userId,
 type:"use",
 shop:shopId,
 time: Timestamp.now(),
useCode: code
});

const timeStr =
new Date(now).toLocaleString();

document.getElementById("app").innerHTML=`
<div class="card">
<h2>利用完了</h2>
<p><strong>${shops[shopId]}</strong></p>
<p>${timeStr}</p>
<p>－3ポイント</p>
<div class="code">${code}</div>
<p style="font-size:12px;">※店舗へこのコードを提示してください</p>
<br>
<button onclick="location.href=location.origin">ホームへ戻る</button>
</div>
`;

}

/* 管理ログイン */
window.showAdminLogin=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="loginModal">
<div class="modalContent">
<h3>関係者コード</h3>
<input type="password" id="codeInput"><br>
<button onclick="checkCode()">ログイン</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>`);
};

window.checkCode=function(){
const c=document.getElementById("codeInput").value;
if(c===STAFF_CODE){
closeModal();
showAdminPanel();
}else{alert("違います");}
};

window.closeModal=function(){
document.getElementById("loginModal").remove();
};

/* 管理パネル */
window.showAdminPanel=function(){
document.body.insertAdjacentHTML("beforeend",`
<div class="modal" id="adminPanel">
<div class="modalContent">
<h3>管理メニュー</h3>
<input type="number" id="manualPoint" placeholder="ポイント数"><br>
<button onclick="manualAdd()">手動付与</button>
<button onclick="manualRemove()">手動削除</button>
<button onclick="resetPoints()">ポイントリセット</button>
<button onclick="fullReset()">完全初期化</button>
<button onclick="closePanel()">閉じる</button>
</div>
</div>`);
};

window.closePanel=function(){
document.getElementById("adminPanel").remove();
};

window.manualAdd=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points+val});
alert("付与完了");
};

window.manualRemove=async function(){
const val=parseInt(document.getElementById("manualPoint").value);
const ref=doc(db,"users",userId);
const snap=await getDoc(ref);
await updateDoc(ref,{points:snap.data().points-val});
alert("削除完了");
};

window.resetPoints=async function(){
await updateDoc(doc(db,"users",userId),{points:0});
alert("リセット完了");
};

window.fullReset=async function(){
await updateDoc(doc(db,"users",userId),{
points:0,
surveyCompleted:false
});
alert("完全初期化完了");
location.reload();
};

init();
</script>
</body>
</html>
