<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ</title>

<style>
body{
  font-family:sans-serif;
  background:#f4f1ea;
  margin:0;
}
.hero{
  background:#c05a2b;
  color:white;
  padding:30px;
  text-align:center;
}
.section{
  padding:25px;
}
.card{
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,0.1);
  max-width:500px;
  margin:20px auto;
  text-align:center;
}
button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:#c05a2b;
  color:white;
  cursor:pointer;
  margin:10px;
}
select,input{
  padding:10px;
  border-radius:8px;
  width:80%;
  margin-top:10px;
}
.code{
  font-size:36px;
  letter-spacing:6px;
  margin:15px 0;
}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDUpuvtfZfMormV9qusrkibD5NBImPsIAI",
  authDomain: "retro-point.firebaseapp.com",
  projectId: "retro-point",
  storageBucket: "retro-point.firebasestorage.app",
  messagingSenderId: "522866949412",
  appId: "1:522866949412:web:47ae009c10fa2ae14707b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const shops = {
  shop01:"ãŸã“ãŸã“",
  shop02:"ã“ã¿ã¡é£Ÿå ‚",
  shop03:"ãƒ¬ãƒˆãƒ­ã‚«ãƒ•ã‚§"
};

const params = new URLSearchParams(location.search);
const mode = params.get("mode");
const shopId = params.get("shop");

let userId = localStorage.getItem("retroUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("retroUserId", userId);
}

async function initUser(){
  const userRef = doc(db,"users",userId);
  const snap = await getDoc(userRef);

  if(!snap.exists()){
    await setDoc(userRef,{
      points:0,
      surveyCompleted:false
    });
    renderSurvey();
  }else{
    const data = snap.data();
    if(!data.surveyCompleted){
      renderSurvey();
    }else{
      route();
    }
  }
}

/* ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ */
function renderSurvey(){
  document.getElementById("app").innerHTML=`
  <div class="card">
    <h2>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å›ç­”ãã ã•ã„</h2>

    <p>åœ¨ä½ã‚¨ãƒªã‚¢</p>
    <select id="area">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option>æ´²æœ¬å¸‚</option>
      <option>æ´²æœ¬å¸‚å¤–</option>
      <option>æ·¡è·¯å³¶å†…</option>
      <option>æ·¡è·¯å³¶å¤–</option>
    </select>

    <p>å¹´ä»£</p>
    <select id="age">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option>10ä»£</option>
      <option>20ä»£</option>
      <option>30ä»£</option>
      <option>40ä»£</option>
      <option>50ä»£ä»¥ä¸Š</option>
    </select>

    <br>
    <button onclick="submitSurvey()">å›ç­”ã—ã¦å‚åŠ ã™ã‚‹</button>
  </div>`;
}

window.submitSurvey = async function(){
  const area = document.getElementById("area").value;
  const age = document.getElementById("age").value;

  if(!area || !age){
    alert("ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  await updateDoc(doc(db,"users",userId),{
    surveyCompleted:true,
    survey:{
      area,
      age,
      answeredAt:Date.now()
    }
  });

  route();
};

/* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° */
function route(){
  if(mode==="add" && shopId){
    renderAdd();
  }else if(mode==="use" && shopId){
    renderUse();
  }else{
    renderHome();
  }
}

/* ãƒ›ãƒ¼ãƒ  */
async function renderHome(){
  const snap = await getDoc(doc(db,"users",userId));
  const points = snap.data().points;

  document.getElementById("app").innerHTML=`
  <div class="hero">
    <h1>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ</h1>
  </div>

  <div class="section">
    <div class="card">
      <h2>ç¾åœ¨ ${points} ãƒã‚¤ãƒ³ãƒˆ</h2>
      <p>åº—èˆ—QRã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã§ãã¾ã™</p>
    </div>
  </div>

  <div class="section">
    <div class="card">
      <h2>é–‹å‚¬æ¦‚è¦</h2>
      <p>å¯¾è±¡åº—èˆ—ã§300å††ã”ã¨ã«1ãƒã‚¤ãƒ³ãƒˆä»˜ä¸</p>
    </div>
  </div>

  <div class="section">
    <div class="card">
      <h2>å‚åŠ æ–¹æ³•</h2>
      <p>â‘  åº—èˆ—QRã‚’èª­ã‚€<br>
         â‘¡ é‡‘é¡å…¥åŠ›<br>
         â‘¢ ãƒã‚¤ãƒ³ãƒˆç²å¾—<br>
         â‘£ 3ãƒã‚¤ãƒ³ãƒˆã§ç‰¹å…¸åˆ©ç”¨</p>
    </div>
  </div>

  <div class="section">
    <div class="card">
      <h2>æ™¯å“ç´¹ä»‹</h2>
      <p>ğŸ ãŸã“ãŸã“ 100å††å¼•ã<br>
         ğŸ ã“ã¿ã¡é£Ÿå ‚ ãƒˆãƒƒãƒ”ãƒ³ã‚°ç„¡æ–™<br>
         ğŸ ãƒ¬ãƒˆãƒ­ã‚«ãƒ•ã‚§ ãƒ‰ãƒªãƒ³ã‚¯50å††å¼•ã</p>
    </div>
  </div>`;
}

/* ä»˜ä¸ */
async function renderAdd(){
  const shopName = shops[shopId];
  document.getElementById("app").innerHTML=`
  <div class="card">
    <h2>${shopName}</h2>
    <input type="number" id="amount" placeholder="è³¼å…¥é‡‘é¡ï¼ˆå††ï¼‰">
    <br>
    <button onclick="addPoints()">ãƒã‚¤ãƒ³ãƒˆä»˜ä¸</button>
  </div>`;
}

window.addPoints = async function(){
  const amount = parseInt(document.getElementById("amount").value);
  if(!amount || amount<300){
    alert("300å††ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const addPoint = Math.floor(amount/300);
  const userRef = doc(db,"users",userId);
  const snap = await getDoc(userRef);
  const newTotal = snap.data().points + addPoint;

  await updateDoc(userRef,{points:newTotal});

  await addDoc(collection(db,"logs"),{
    userId,
    type:"add",
    shop:shopId,
    amount,
    points:addPoint,
    time:Date.now()
  });

  document.getElementById("app").innerHTML=`
  <div class="card">
    <h2>ä»˜ä¸å®Œäº†</h2>
    <p>${addPoint}ãƒã‚¤ãƒ³ãƒˆç²å¾—</p>
    <h3>ç¾åœ¨ ${newTotal}ãƒã‚¤ãƒ³ãƒˆ</h3>
    <button onclick="location.href=location.origin">ãƒ›ãƒ¼ãƒ ã¸</button>
  </div>`;
};

/* åˆ©ç”¨ */
async function renderUse(){
  const snap = await getDoc(doc(db,"users",userId));
  const current = snap.data().points;

  if(current<3){
    document.getElementById("app").innerHTML=`
      <div class="card">
        <h2>ãƒã‚¤ãƒ³ãƒˆä¸è¶³</h2>
      </div>`;
    return;
  }

  document.getElementById("app").innerHTML=`
  <div class="card">
    <button onclick="usePoints()">3ãƒã‚¤ãƒ³ãƒˆã§åˆ©ç”¨</button>
  </div>`;
}

window.usePoints = async function(){
  const userRef = doc(db,"users",userId);
  const snap = await getDoc(userRef);
  const newTotal = snap.data().points-3;

  const code = Math.floor(100+Math.random()*900)
      +String.fromCharCode(65+Math.floor(Math.random()*26));

  await updateDoc(userRef,{points:newTotal});

  await addDoc(collection(db,"logs"),{
    userId,
    type:"use",
    shop:shopId,
    code,
    time:Date.now()
  });

  const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  document.getElementById("app").innerHTML=`
  <div class="card">
    <h2>åˆ©ç”¨ç•ªå·</h2>
    <p>${now}</p>
    <div class="code">${code}</div>
    <button onclick="location.href=location.origin">ãƒ›ãƒ¼ãƒ ã¸</button>
  </div>`;
};

initUser();
</script>
</body>
</html>
