<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>店舗ダッシュボード</title>

<style>
body{
 font-family:sans-serif;
 background:#f4f1ea;
 padding:20px;
}
.card{
 background:white;
 padding:20px;
 border-radius:12px;
 max-width:500px;
 margin:auto;
 text-align:center;
}
input,select,button{
 padding:10px;
 margin:5px;
}
</style>

</head>
<body>

<div id="app"></div>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
 getFirestore,
 collection,
 query,
 where,
 getDocs
}
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


const firebaseConfig={
 apiKey:"xxx",
 authDomain:"xxx",
 projectId:"retro-point"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);


// 店舗情報
const shops={
 shop01:{
  name:"たこたこ",
  pass:"PASS01"
 },
 shop02:{
  name:"こみち食堂",
  pass:"PASS02"
 },
 shop03:{
  name:"レトロカフェ",
  pass:"PASS03"
 }
};


// 保存されたログイン確認
let loginShop=localStorage.getItem("loginShop");

if(loginShop){
 loadDashboard(loginShop);
}else{
 showLogin();
}



// ログイン画面
function showLogin(){

 document.getElementById("app").innerHTML=`

 <div class="card">

  <h2>店舗ログイン</h2>

  <select id="shopSelect">
   <option value="">店舗選択</option>
   <option value="shop01">たこたこ</option>
   <option value="shop02">こみち食堂</option>
   <option value="shop03">レトロカフェ</option>
  </select>

  <br>

  <input type="password" id="pass" placeholder="パスワード">

  <br>

  <button onclick="login()">ログイン</button>

 </div>

 `;

}


// ログイン処理
window.login=function(){

 const shop=document.getElementById("shopSelect").value;
 const pass=document.getElementById("pass").value;

 if(!shops[shop]){
  alert("店舗選択");
  return;
 }

 if(shops[shop].pass!=pass){
  alert("パスワード違います");
  return;
 }

 localStorage.setItem("loginShop",shop);

 loadDashboard(shop);

}



// ダッシュボード
async function loadDashboard(shop){

 const shopName=shops[shop].name;

 document.getElementById("app").innerHTML=`

 <div class="card">

  <h2>${shopName}</h2>

  <div id="stats">読み込み中...</div>

  <button onclick="logout()">ログアウト</button>

 </div>

 `;


 const q=query(
  collection(db,"logs"),
  where("shop","==",shop)
 );

 const snap=await getDocs(q);

 let total=0;
 let count=0;

 snap.forEach(doc=>{

  const d=doc.data();

  if(d.type=="add"){
   total+=d.points;
   count++;
  }

 });


 document.getElementById("stats").innerHTML=`

  <p>付与回数: ${count}</p>

  <p>付与ポイント: ${total}</p>

 `;

}


// ログアウト
window.logout=function(){

 localStorage.removeItem("loginShop");

 location.reload();

}


</script>

</body>
</html>
