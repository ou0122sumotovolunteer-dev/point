<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f6f1e8;}
header{background:#8b5e3c;color:#fff;padding:15px;font-size:20px;}
.section{background:#fff;margin:15px;padding:15px;border-radius:10px;}
button{padding:6px 10px;background:#8b5e3c;color:white;border:none;border-radius:6px;margin:3px;cursor:pointer;}
button:hover{opacity:0.9;}
.stat{font-size:20px;font-weight:bold;color:#8b5e3c;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
td,th{border-bottom:1px solid #ddd;padding:6px;text-align:left;}
.logBox{max-height:200px;overflow:auto;background:#fafafa;padding:5px;font-size:12px;}
.danger{color:red;font-weight:bold;}
input,textarea{padding:6px;width:100%;}
</style>
</head>
<body>

<header>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>

<div class="section">
<h3>ğŸš¨ ä¸æ­£æ¤œçŸ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
<table>
<thead>
<tr>
<th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
<th>ç†ç”±</th>
<th>å¯¾å¿œ</th>
</tr>
</thead>
<tbody id="fraudTable"></tbody>
</table>
</div>

<div class="section">
<h3>ğŸ“© ç•°è­°ç”³ã—ç«‹ã¦ä¸€è¦§</h3>
<table>
<thead>
<tr>
<th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
<th>å†…å®¹</th>
<th>å‡¦ç†</th>
</tr>
</thead>
<tbody id="appealTable"></tbody>
</table>
</div>

<div class="section">
<h3>ğŸ’³ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
<table>
<thead>
<tr>
<th>ID</th>
<th>ãƒã‚¤ãƒ³ãƒˆ</th>
<th>çŠ¶æ…‹</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
getFirestore, collection, getDocs,
doc, updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"ã“ã“ã«æœ¬ç‰©",
authDomain:"retro-point.firebaseapp.com",
projectId:"retro-point"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let usersCache=[];
let logsCache=[];

async function loadData(){

const usersSnap=await getDocs(collection(db,"users"));
const logsSnap=await getDocs(collection(db,"logs"));

usersCache=[];
logsCache=[];

usersSnap.forEach(d=>{
let data=d.data();

/* è‡ªå‹•åœæ­¢è§£é™¤ */
if(data.status==="banned" && data.banUntil){
let now=new Date();
let until=new Date(data.banUntil.seconds*1000);
if(now>until){
updateDoc(doc(db,"users",d.id),{status:"active",banReason:"",banUntil:null});
data.status="active";
}
}

usersCache.push({id:d.id,...data});
});

logsSnap.forEach(d=>logsCache.push({id:d.id,...d.data()}));

renderFraud();
renderUsers();
renderAppeals();
}

function renderFraud(){

let fraudHTML="";
let userLogMap={};

logsCache.forEach(l=>{
if(!userLogMap[l.userId]) userLogMap[l.userId]=[];
userLogMap[l.userId].push(l);
});

for(let uid in userLogMap){
let logs=userLogMap[uid];

let adds=logs.filter(x=>x.type==="add"&&x.time?.seconds)
.sort((a,b)=>a.time.seconds-b.time.seconds);

for(let i=2;i<adds.length;i++){
if(adds[i].time.seconds-adds[i-2].time.seconds<600){
fraudHTML+=rowFraud(uid,"çŸ­æ™‚é–“å¤§é‡ä»˜ä¸");
break;
}
}
}

document.getElementById("fraudTable").innerHTML=
fraudHTML||"<tr><td colspan='3'>ç•°å¸¸ãªã—</td></tr>";
}

function rowFraud(uid,reason){
return `
<tr>
<td>${uid}</td>
<td class="danger">${reason}</td>
<td>
<button onclick="markSafe('${uid}')">å•é¡Œãªã—</button>
<button onclick="markHold('${uid}')">ä¿ç•™</button>
<button onclick="markBan('${uid}')">åˆ©ç”¨åœæ­¢</button>
</td>
</tr>`;
}

/* ===== çŠ¶æ…‹å¤‰æ›´ ===== */

window.markSafe=async(uid)=>{
await updateDoc(doc(db,"users",uid),{status:"active"});
alert("å•é¡Œãªã—ã«ã—ã¾ã—ãŸ");
loadData();
};

window.markHold=async(uid)=>{
await updateDoc(doc(db,"users",uid),{status:"hold"});
alert("ä¿ç•™ã«ã—ã¾ã—ãŸ");
loadData();
};

window.markBan=async(uid)=>{
let reason=prompt("åœæ­¢ç†ç”±");
if(!reason) return;

let until=prompt("åœæ­¢æœŸé™ yyyy-mm-dd ã¾ãŸã¯ æœªå®š");

let value=null;
if(until && until!=="æœªå®š"){
value=new Date(until);
}

await updateDoc(doc(db,"users",uid),{
status:"banned",
banReason:reason,
banUntil:value
});

alert("åˆ©ç”¨åœæ­¢ã—ã¾ã—ãŸ");
loadData();
};

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†è¡¨ç¤º ===== */

function renderUsers(){
let html="";

usersCache.forEach(u=>{
html+=`
<tr>
<td>${u.id}</td>
<td>${u.points||0}</td>
<td>${u.status||"active"}</td>
<td>
<button onclick="releaseUser('${u.id}')">è§£é™¤</button>
</td>
</tr>`;
});

document.getElementById("userTable").innerHTML=html;
}

window.releaseUser=async(uid)=>{
await updateDoc(doc(db,"users",uid),{
status:"active",
banReason:"",
banUntil:null
});
alert("è§£é™¤ã—ã¾ã—ãŸ");
loadData();
};

/* ===== ç•°è­°ç”³ã—ç«‹ã¦ ===== */

function renderAppeals(){
let html="";

usersCache.forEach(u=>{
if(u.appeal && u.appeal.status==="pending"){
html+=`
<tr>
<td>${u.id}</td>
<td>${u.appeal.message}</td>
<td>
<button onclick="approveAppeal('${u.id}')">æ‰¿èª</button>
<button onclick="rejectAppeal('${u.id}')">å´ä¸‹</button>
</td>
</tr>`;
}
});

document.getElementById("appealTable").innerHTML=
html||"<tr><td colspan='3'>ãªã—</td></tr>";
}

window.approveAppeal=async(uid)=>{
await updateDoc(doc(db,"users",uid),{
status:"active",
appeal:{status:"approved"}
});
alert("åˆ©ç”¨å†é–‹");
loadData();
};

window.rejectAppeal=async(uid)=>{
await updateDoc(doc(db,"users",uid),{
appeal:{status:"rejected"}
});
alert("å´ä¸‹ã—ã¾ã—ãŸ");
loadData();
};

loadData();

</script>
</body>
</html>
