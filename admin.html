<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f6f1e8;}
header{background:#8b5e3c;color:#fff;padding:15px;font-size:18px;}
.section{background:#fff;margin:15px;padding:15px;border-radius:10px;}
h2{margin-top:0;}
.stat{font-size:22px;font-weight:bold;color:#8b5e3c;}
input{padding:10px;width:200px;}
button{padding:8px 12px;background:#8b5e3c;color:white;border:none;border-radius:6px;}
table{width:100%;border-collapse:collapse;}
td,th{border-bottom:1px solid #ddd;padding:6px;text-align:left;}
.alert{color:red;font-weight:bold;}
</style>
</head>
<body>

<header>ãƒ¬ãƒˆãƒ­ã“ã¿ã¡ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>

<div class="section">
<h2>ğŸ“ˆ å…¨ä½“çµ±è¨ˆ</h2>
<div>ç·å‚åŠ äººæ•°ï¼š<span id="totalUsers" class="stat">0</span></div>
<div>ç·ãƒã‚¤ãƒ³ãƒˆç™ºè¡Œæ•°ï¼š<span id="totalIssued" class="stat">0</span></div>
<div>ç·åˆ©ç”¨å›æ•°ï¼š<span id="totalUsed" class="stat">0</span></div>
</div>

<div class="section">
<h2>ğŸ§‘â€ğŸ¤â€ğŸ§‘ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆ</h2>
<div>æ´²æœ¬å¸‚å‰²åˆï¼š<span id="sumotoRate" class="stat">0%</span></div>
<canvas id="ageChart"></canvas>
</div>

<div class="section">
<h2>ğŸª åº—èˆ—åˆ¥é›†è¨ˆ</h2>
<table>
<thead><tr><th>åº—èˆ—</th><th>ä»˜ä¸æ•°</th><th>åˆ©ç”¨æ•°</th></tr></thead>
<tbody id="shopTable"></tbody>
</table>
</div>

<div class="section">
<h2>ğŸš¨ ä¸æ­£æ¤œçŸ¥</h2>
<div id="fraudArea"></div>
</div>

<div class="section">
<h2>ğŸ§¾ åˆ©ç”¨ã‚³ãƒ¼ãƒ‰ç…§åˆ</h2>
<input id="codeInput" placeholder="åˆ©ç”¨ã‚³ãƒ¼ãƒ‰">
<button onclick="checkCode()">ç¢ºèª</button>
<div id="codeResult"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={/* åŒã˜è¨­å®š */};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

async function loadDashboard(){

const usersSnap=await getDocs(collection(db,"users"));
const logsSnap=await getDocs(collection(db,"logs"));

let totalUsers=usersSnap.size;
let totalIssued=0;
let totalUsed=0;

let areaCount=0;
let sumotoCount=0;

let ageMap={};
let shopMap={};
let fraudMap={};

logsSnap.forEach(docu=>{
let d=docu.data();
if(d.type==="ä»˜ä¸"){
totalIssued+=d.points;
}
if(d.type==="åˆ©ç”¨"){
totalUsed++;
}

if(!shopMap[d.shop]) shopMap[d.shop]={add:0,use:0};
if(d.type==="ä»˜ä¸") shopMap[d.shop].add+=d.points;
if(d.type==="åˆ©ç”¨") shopMap[d.shop].use++;

if(!fraudMap[d.userId]) fraudMap[d.userId]=[];
fraudMap[d.userId].push(d.time);
});

usersSnap.forEach(docu=>{
let u=docu.data();
if(u.surveyData){
areaCount++;
if(u.surveyData.area==="æ´²æœ¬å¸‚") sumotoCount++;
let age=u.surveyData.age;
if(!ageMap[age]) ageMap[age]=0;
ageMap[age]++;
}
});

document.getElementById("totalUsers").innerText=totalUsers;
document.getElementById("totalIssued").innerText=totalIssued;
document.getElementById("totalUsed").innerText=totalUsed;
document.getElementById("sumotoRate").innerText=
Math.round((sumotoCount/areaCount)*100)+"%";

/* å¹´ä»£ã‚°ãƒ©ãƒ• */
new Chart(document.getElementById("ageChart"),{
type:"pie",
data:{
labels:Object.keys(ageMap),
datasets:[{data:Object.values(ageMap)}]
}
});

/* åº—èˆ—è¡¨ */
let table="";
for(let shop in shopMap){
table+=`<tr><td>${shop}</td><td>${shopMap[shop].add}</td><td>${shopMap[shop].use}</td></tr>`;
}
document.getElementById("shopTable").innerHTML=table;

/* ä¸æ­£æ¤œçŸ¥ */
let fraudHTML="";
for(let user in fraudMap){
let times=fraudMap[user].sort();
for(let i=1;i<times.length;i++){
if(times[i]-times[i-1]<60000){
fraudHTML+=`<div class="alert">çŸ­æ™‚é–“é€£ç¶šä»˜ä¸ï¼š${user}</div>`;
break;
}
}
}
document.getElementById("fraudArea").innerHTML=fraudHTML||"ç•°å¸¸ãªã—";
}

/* ã‚³ãƒ¼ãƒ‰ç…§åˆ */
window.checkCode=async function(){
let code=document.getElementById("codeInput").value;
const logsSnap=await getDocs(collection(db,"logs"));
let found=null;
logsSnap.forEach(d=>{
if(d.data().useNo==code) found=d;
});
if(!found){
document.getElementById("codeResult").innerText="ç„¡åŠ¹ã‚³ãƒ¼ãƒ‰";
}else{
await updateDoc(doc(db,"logs",found.id),{verified:true});
document.getElementById("codeResult").innerText="æœ‰åŠ¹ãƒ»ç¢ºèªæ¸ˆã¿ã«æ›´æ–°";
}
}

loadDashboard();
</script>
</body>
</html>
