<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>店舗ダッシュボード</title>

<style>
body{
 font-family:sans-serif;
 background:#f4f1ea;
 padding:20px;
}
.card{
 background:white;
 padding:20px;
 border-radius:12px;
 max-width:500px;
 margin:auto;
}
</style>

</head>
<body>

<div class="card">

<h2 id="shopName"></h2>

<div id="stats"></div>

<h3>履歴</h3>
<div id="history"></div>

</div>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
 getFirestore,
 collection,
 query,
 where,
 getDocs
}
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


const firebaseConfig = {
 apiKey:"xxx",
 authDomain:"xxx",
 projectId:"retro-point"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);


// 店舗パスワード
const shopPasswords={
 shop01:"PASS01",
 shop02:"PASS02",
 shop03:"PASS03"
};


// URL取得
const params=new URLSearchParams(location.search);

const shop=params.get("shop");
const code=params.get("code");


// 認証
if(!shopPasswords[shop] || shopPasswords[shop]!=code){

 document.body.innerHTML="<h2>ログイン失敗</h2>";
 throw "no auth";

}


// 店舗名
const shopNames={
 shop01:"たこたこ",
 shop02:"こみち食堂",
 shop03:"レトロカフェ"
};

document.getElementById("shopName").innerText=
 shopNames[shop]+" ダッシュボード";



// データ取得
const q=query(
 collection(db,"logs"),
 where("shop","==",shop)
);

const snap=await getDocs(q);


let total=0;
let count=0;
let history="";


snap.forEach(doc=>{

 const d=doc.data();

 if(d.type=="add"){
  total+=d.points;
  count++;
 }

 const time=new Date(d.time).toLocaleString();

 history+=`
  <div>
   ${d.type} ${d.points||3}P
   ${time}
  </div>
 `;

});


document.getElementById("stats").innerHTML=`

<p>付与回数: ${count}</p>

<p>付与ポイント合計: ${total}</p>

`;

document.getElementById("history").innerHTML=history;

</script>

</body>
</html>
